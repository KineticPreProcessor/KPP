.. _creating_fortran_files:

############################################################
Creating Fortran-90 chemical mechanism modules for GEOS-Chem
############################################################

--------------------------------------------------------
Navigate to the KPP folder in your GEOS-Chem source code
--------------------------------------------------------

At this point you can now use :program:`KPP-for-GEOS-Chem` to generate Fortran-90 source code
files that will solve the chemical mechanism in an efficient manner.

.. important::  The configuration files that define the various
		GEOS-Chem chemical mechanisms are kept with the
		`GEOS-Chem source code <https://github.com/geoschem/geos-chem/>`__.  For
		the purposes of this tutorial, we will assume that you
		have already downloaded GEOS-Chem (either as
		`GEOS-Chem "Classic" <https://github.com/geoschem/GCClassic>`__ or
		`GCHP <https://github.com/geoschem/GCHP>`__) to your
		computer system.
		
Navigate to this folder in your :program:`GEOS-Chem` source code:

-  GEOS-Chem 12.9.3 and prior versions: :file:`KPP`
-  GEOS-Chem 13.0.0 and later versions: :file:`src/GEOS-Chem/KPP`
-  GCHP 13.0.0 and later versions:
   :file:`src/GCHP_GridComp/GEOSChem_GridComp/geos-chem/KPP`


Here you will find a sub-folder named :file:`custom` and a script
named :file:`build_mechanism.sh`. You will also find a few other
sub-folders with names such as :file:`fullchem` (in GEOS-Chem 13), or
:file:`Standard`, :file:`Tropchem`, etc. (in GEOS-Chem 12).

.. important:: These :file:`fullchem`, :file:`Standard`, :file:`Tropchem`, etc. sub-folders contain Fortran-90 source code files that have been  generated by :program:`KPP-for-GEOS-Chem`.  You should leave these files untouched.

The :file:`custom` folder contains sample chemical mechanism
specification files (:file:`custom.eqn` and :file:`gckpp.kpp`), which
are copies of the default GEOS-Chem mechanism. You can edit these files to define your
own custom mechanism (see subsequent sections for detailed
instructions).

---------------------------------
Run the build_mechanism.sh script
---------------------------------
	  
Once you are satisfied with your custom mechanism specification you may
now use KPP-for-GEOS-Chem to build the source code files for GEOS-Chem.

Return to the KPP folder containing ``build_mechanism.sh`` and then type:

.. code-block:: console

   $ ./build_mechanism.sh custom

The ``build_mechanism.sh`` script runs the
:program:`KPP-for-GEOS-Chem` executable (which is named :file:`gckpp`)
on the :file:`gckpp.kpp` configuration file.  It also runs a python script to generate code for the OH reactivity diagnostic.
	
Once you run the ``build_mechanism.sh`` script, you will see output similar to this:

.. code-block:: none

  This is KPP-X.Y.Z_gc.
  KPP is parsing the equation file.
  KPP is computing Jacobian sparsity structure.
  KPP is starting the code generation.
  KPP is initializing the code generation.
  KPP is generating the monitor data:
    - gckpp_Monitor
  KPP is generating the utility data:
    - gckpp_Util
  KPP is generating the global declarations:
    - gckpp_Main
  KPP is generating the ODE function:
    - gckpp_Function
  KPP is generating the ODE Jacobian:
    - gckpp_Jacobian
    - gckpp_JacobianSP
  KPP is generating the linear algebra routines:
    - gckpp_LinearAlgebra
  KPP is generating the utility functions:
    - gckpp_Util
  KPP is generating the rate laws:
    - gckpp_Rates
  KPP is generating the parameters:
    - gckpp_Parameters
  KPP is generating the global data:
    - gckpp_Global
  KPP is generating the driver from none.f90:
    - gckpp_Main
  KPP is starting the code post-processing.
  
  KPP has succesfully created the model "gckpp".
  
  Reactivity consists of 172 reactions
  Written to gckpp_Util.F90

where ``X.Y.Z`` denotes the :program:`KPP-for-GEOS-Chem` version that you are using.
  
If this process is successful, the :file:`custom` folder should now be
populated with several :file:`.F90` source code files:

.. code-block:: none

  CMakeLists.txt*      gckpp_Initialize.F90  gckpp_LinearAlgebra.F90  gckpp_Precision.F90
  custom.eqn           gckpp_Integrator.F90  gckpp.map                gckpp_Rates.F90
  gckpp_Function.F90   gckpp_Jacobian.F90    gckpp_Model.F90          gckpp_Util.F90
  gckpp_Global.F90     gckpp_JacobianSP.F90  gckpp_Monitor.F90        Makefile_gckpp
  gckpp_HetRates.F90@  gckpp.kpp             gckpp_Parameters.F90

These files contain optimized Fortran-90 instructions for solving the chemical
mechanism that you have specified.
